---
title: "Create a markdown page for each region in the OHI website"
author: "Robyn Thiessen-Bock"
date: "2021-07-07"
---

This R code reads in the `scores.csv` file and creates a markdown page for each country/region in the scores file.

```{r}
library(here)
library(dplyr)
library(magrittr)
library(stringi)
```

```{r}
# Path to the scores.csv file
scores_path <- here("content", "data", "scores.csv")
# Path to where the region markdown pages should be created. This directory must already exist.
output_dir <- here("content", "regions")
# In the scores.csv file, the name for the column that contains the region names
name_col <- "region_name"
# In the scores.csv file, the name for the column that contains the region Ids
id_col <- "region_id"
# In the scores.csv file, the names of any regions that we should not create pages for
exclude_regions <- c("Global average")
# The template to use when creating front-matter for the region markdown file page. $id and $name are replaced with the region ID and name.
template <- "---
regionId: $id
title: $name
layout: region_score
---"
```

```{r}
# Get the data from the scores csv file
scores_data <- read.csv(scores_path)

# Get just the unique region names and IDs, exclude any that are not needed
page_data <- scores_data %>% 
	select(name_col, id_col) %>% 
	distinct() %>% 
	filter(!(!!as.symbol(name_col) %in% exclude_regions))
```

```{r}
# Make a markdown file for each region
for (row in 1:nrow(page_data)) {
	
	name <- page_data[row, name_col]
	id  <- page_data[row, id_col]
	
	templateCopy <- template
	templateCopy <- gsub("\\$id", id, templateCopy)
	templateCopy <- gsub("\\$name", name, templateCopy)
	templateCopy
	
	# Make the markdown file name from the region name
	fileName <- name %>%
		tolower() %>% # make lower case
		gsub("\\s*\\([^\\)]+\\)","", .) %>% # remove text between parentheses at end of name
		stri_trans_general("Latin-ASCII") %>% # convert characters with accents to non-accented character
		gsub("\\s","-", .) %>%  # convert spaces to dashes
		paste0(., ".md") #Add the markdown extension
	
	fileConn<-file(here(output_dir, fileName))
	writeLines(templateCopy, fileConn)
	close(fileConn)
}
```